<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-startup-image" href="https://www.wepora.com/asset/img/wepora-logo.png">
  <link rel="icon" type="image/x-icon" href="https://www.wepora.com/asset/img/wepora-logo.png">
  <meta name="description" content="Wepora is a best Graphics, software and Web Development company  and provides all IT solutions to their client. In india.." />
  <meta name="Keywords" content="website design | website development | website logo  |  website hosting  | logo design| logo design ideas  | SEO | android |  best software company in india | cheapest | graphic design | Shrikant Kushwaha">
  <meta name="author" content="contain by Wepora team">
  <meta name="copyright" content="Copyright Â© 2020 Wepora" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="./socket.io.js"></script>
  <title>Wepora Snippets</title>
</head>

<body>
  <!--content start-->

  <script type="module">
    const MyUtil = {
      finalArray: [],
      addNewDayObject: function (dayObject) {
        const _index = MyUtil.finalArray.findIndex((_obj) => new Date(_obj.date) > new Date(dayObject.date));
        MyUtil.finalArray.splice(_index, 0, dayObject);
      },
      sortMessagesByDate: function (messages) {
        return messages.sort(function (a, b) {
          // Turn your strings into dates, and then subtract them
          // to get a value that is either negative, positive, or zero.
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
      },
      createDayGroups: function (messages) {
        const groups = messages.reduce((groups, message) => {
          const date = message.createdAt.split('T')[0];
          if (!groups[date]) {
            groups[date] = [];
          }
          groups[date].push(message);
          return groups;
        }, {});

        const groupArrays = Object.keys(groups).map((date) => {
          return {
            date,
            messageGroups: groups[date]
          };
        });
        return groupArrays;
      },
      createGroupMessages: function (messages) {
        const messageGroups = [];
        messages.forEach(message => {
          const _message = { ...message };
          delete _message.user;
          if (messageGroups[messageGroups.length - 1]?.user._id == message.user._id) {
            messageGroups[messageGroups.length - 1].messages.push(_message);
            messageGroups[messageGroups.length - 1].endAt = _message.createdAt;
          } else {
            const obj = {
              user: message.user,
              startAt: _message.createdAt,
              endAt: _message.createdAt,
              messages: [_message],
            };
            messageGroups.push(obj);
          }
        });
        return messageGroups;
      },
      generateArray: function (messagesArray) {
        const sortedMessages = MyUtil.sortMessagesByDate(messagesArray);
        const groupArrays = MyUtil.createDayGroups(sortedMessages);
        const _finalArray = groupArrays.map((group) => {
          group.messageGroups = MyUtil.createGroupMessages(group.messageGroups);
          return group;
        });
        MyUtil.finalArray = _finalArray;
      },
      newMessage: function (message) {
        const messageDay = message.createdAt.split('T')[0];
        const dayIndex = MyUtil.finalArray.findIndex((day) => day.date === messageDay);
        if (dayIndex == -1) {
          const obj = {
            date: messageDay,
            messages: [{
              startAt: message.createdAt,
              endAt: message.createdAt,
              messages: [message],
              user: message.user,
            }],
          };
          MyUtil.addNewDayObject(obj);
          console.log("added new day object", messageDay);
        } else {
          console.log("day exist --->", messageDay);
          MyUtil.addMessageToDay(dayIndex, message);
        }
        console.log(MyUtil.finalArray);
      },
      addMessageToDay: function (dayIndex, message) {
        let isMessageGroupExist = false;

        let _index = MyUtil.finalArray[dayIndex].messageGroups.findIndex((messageGroup) => {
          if (new Date(message.createdAt) > new Date(messageGroup.startAt) && new Date(message.createdAt) < new Date(messageGroup.endAt)) {
            console.log("message group exist ----> message", message);
            console.log("message group exist ----> messageGroup", messageGroup);
            isMessageGroupExist = true;
            return true;
          }

          if (new Date(message.createdAt) < new Date(messageGroup.startAt)) {
            // console.log("message group exist ----> message", message);
            // console.log("message group exist ----> messageGroup", messageGroup);
            return true;
          }
        });

        if (isMessageGroupExist) {
          console.log("addMessageToExistGroup");
          // MyUtil.addMessageToExistGroup(dayIndex, _index, message);
        } else {

        }
      },
      addMessageToExistGroup: function (dayIndex, groupIndex, message) {
        const _index = MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.findIndex((_obj) => new Date(_obj.createdAt) > new Date(message.createdAt));
        if (MyUtil.finalArray[dayIndex].messageGroup[groupIndex].user._id == message.user._id) {
          MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.splice(_index, 0, message);
        } else {
          const restMessages = MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.splice(_index);
          MyUtil.finalArray[dayIndex].messageGroup[groupIndex].endAt = MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages[MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.length - 1].createdAt;
          MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.splice(_index + 1, 0, {
            startAt: message.createdAt,
            endAt: message.createdAt,
            messages: [message],
            user: message.user
          });
          MyUtil.finalArray[dayIndex].messageGroup[groupIndex].messages.splice(_index + 2, 0, {
            startAt: restMessages[0].createdAt,
            endAt: message.restMessages[message.restMessages.length - 1].createdAt,
            messages: restMessages,
            user: MyUtil.finalArray[dayIndex].messageGroup[groupIndex].user,
          });
        }
      },
    };

    const socket = io("ws://localhost:3000", {
      reconnectionDelayMax: 10000,
    });
    socket.emit('join');

    socket.on('messages', function (messages) {
      if (messages.length > 1) {
        MyUtil.generateArray(messages);
        console.log(MyUtil.finalArray);
      } else {
        messages.forEach(message => {
          MyUtil.newMessage(message);
          console.log(message);
        });
      }
    });
    socket.on('rooms', function (sessionIds) {
      console.log(sessionIds);
    });


  </script>


  <!--content end-->
  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>
</body>

</html>